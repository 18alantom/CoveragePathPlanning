<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="icofont/icofont.min.css" rel="stylesheet" />
    <link href="static\map.css" rel="stylesheet" type="text/css" />
    <title>SIH MAP</title>
  </head>
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
    }
  </style>

  <body>
    <div id="container">
      <div id="left">
        <div class="form-box1">
          <form id="register1" class="input-group1">
            <img src="static\2025680.svg" id="image" />
            <h3 style="margin-top: 40px;"><b>INPUTS FOR THE PROGRAM</b></h3>
            <input type="number" class="input-field1" id="drone" placeholder="Number of drones" required />
            <input type="number" class="input-field1" id="altitude" placeholder="Altitude" required />
            <input type="number" class="input-field1" id="fov" placeholder="Field Of Vision(Angle)" required />
            <input type="file" name="shapefile" id="shapefile" />
            <div class="select1">
              <select id="select_input">
                <option value="obstacle_present">Obstacle Known</option>
                <option value="no_obstacle">Obstacle Unknown</option>
              </select>
            </div>
            <h4 id="heading">DRONE 1</h4>
            <input type="number" class="input-field1" id="range" placeholder="Range (in km based on battery life)" required />
            <input type="number" class="input-field1" id="speed" placeholder="Top speed (in km/hr)" required />
            <button type="submit" class="submit-btn1" id="button5"><b>NEXT</b></button>
          </form>
        </div>
      </div>

      <div id="center">
        <div id="map"></div>
        <div id="controls">
          <div id="toggle_button">
            <h4><b>OBSTACLES</b></h4>
            <button class="control_button" id="button"><b> ADD OBSTACLE </b></button>
            <button class="control_button" id="button1"><b> CREATE OBSTACLE </b></button>
            <button class="control_button" id="button2"><b> DELETE NODE </b></button>
            <button class="control_button" id="next1"><b> NEXT </b></button>
          </div>
        </div>
      </div>

      <div id="right">
        <div id="form-box2">
          <img src="static\SIH_2018_logo.png" id="image1" />

          <h3 style="margin-top: 40px;"><b>OUTPUT</b></h3>
          <h5 style="padding-top: 10px;"><b> Current Progress: </b></h5>
          <progress id="file" value="0" max="100"> 32% </progress>
          <h5><b> Total Area Covered: </b></h5>
          <input type="text" name="total_area" id="output" /><br />
          <h5 style="padding-top: 10px;"><b> Select Drone: </b></h5>
          <div class="select2">
            <select id="select_input1" onchange="displayDroneData()">
              <option value="drone1">Drone 1</option>
            </select>
          </div>
          <h5 style="padding-top: 10px;"><b> Drone Progress: </b></h5>
          <progress id="file1" value="0" max="100"> </progress>
          <h5 style="padding-top: 10px;"><b> Drone Battery: </b></h5>
          <progress id="file2" value="100" max="100"></progress>
        </div>
      </div>
    </div>
    <script>
      const POINT_NAME = "layers/POINT";
      const POLY_NAME = "layers/POLYGON";
      const OBSTACLE = "obstacle";
      const COVERAGE = "coverage";
      const fileSelector = document.getElementById("shapefile");
      let shapefile_polygon;
      let shapefile_geojson;
      let input;
      let poly_arr = [];
      let obst_arr = [];
      let path_arr = [];
      let midpoint;
      let bigarr = [];
      let drone_arr = [];
      let drone_val = [];
      let drone_len = [];
      let flag_fuel = false;
      let flag_strt = false;

      fileSelector.addEventListener("change", (e) => {
        const shapefile = e.target.files[0];
        const reader = new FileReader();
        reader.readAsArrayBuffer(shapefile);
        reader.onload = onLoadHandler;
      });
      function onLoadHandler() {
        shp(this.result).then((geojson) => {
          shapefile_geojson = geojson;
          console.log(shapefile_geojson);
          // geojson_ = geojson;
          let coverageFeatureCollection = null;
          const obstacles = [];
          const coverage = [];
          // console.log(geojson);
          geojson.forEach((element) => {
            if (element.fileName == POINT_NAME) {
              map.data.addGeoJson(element);
            }
            if (element.fileName == POLY_NAME) {
              element.features.forEach((feature) => {
                // Why has he put this weird regex here?
                const type = feature.properties.type.match(/[a-z]*/i)[0];
                const coords = feature.geometry.coordinates[0];
                if (type == COVERAGE) {
                  coverage.push(coords);
                } else if (type == OBSTACLE) {
                  obstacles.push(coords);
                } else {
                  bloop = type;
                }
              });
            }
          });
          const poly = turf.polygon(coverage);
          const mask = turf.polygon(obstacles);
          console.log(poly);
          console.log(mask);

          const p = turf.mask(poly, mask);
          // console.log(p);
          // console.log(mask);
          const len = mask.geometry.coordinates.length;
          const q = mask.geometry.coordinates;

          for (var i = 0; i < p.geometry.coordinates[1].length; i++) {
            var temp = { lng: p.geometry.coordinates[1][i][0], lat: p.geometry.coordinates[1][i][1] };
            poly_arr.push(temp);
          }

          path_arr.push(poly_arr);

          for (var j = 0; j < len; j++) {
            for (var i = q[j].length - 1; i >= 0; i--) {
              var ob_temp = { lng: q[j][i][0], lat: q[j][i][1] };
              obst_arr.push(ob_temp);
            }
            path_arr.push(obst_arr);
            //console.log(path_arr);
            obst_arr = [];
          }

          midpoint = turf.centroid(poly);

          shapefile_polygon = new google.maps.Polygon({
            paths: path_arr,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
          });

          shapefile_polygon.setMap(map);
        });
      }
    </script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script>
      let map;
      let arr = [];
      let reverse_arr = [];
      let obs_marker;
      let obs_marker_arr = [];
      let fuel_marker = [];
      let fuel_marker_arr = [];
      let drone_marker = [];
      let drone_marker_arr = [];
      let pathCoords1 = [];
      let pathCoords2 = [];
      let pathCoords = [];
      let route = [];
      let ani_marker = [];
      let range = [];
      let speed = [];
      let no_drones = 1;
      let value_no_drones = 0;
      let altitude;
      let fov;
      let side;
      let un_kn_obstacle;
      let mapContainerDiv;
      let temp = "yash";
      let drone_prog_count = [];
      let flag_pause = false;
      let current_P = [];
      let timeouts_P = [];

      mapContainerDiv = document.getElementById("map");
      function initMap() {
        const postSIHParty = {
          lng: 72.88804829120636,
          lat: 19.080222794769302,
          zoom: 14,
        };
        map = new google.maps.Map(mapContainerDiv, { zoom: 12, center: postSIHParty });
        const marker = new google.maps.Marker({ map: map, zoom: 14, position: postSIHParty });

        // Create the initial InfoWindow.
        var infoWindow = new google.maps.InfoWindow({
          content: "Click on ADD OBSTCALE to get Lat/Lng!",
          position: postSIHParty,
        });

        infoWindow.open(map);

        //Add obstacle
        document.getElementById("button").addEventListener("click", function () {
          shapefile_polygon.addListener("click", function (mapsMouseEvent) {
            // Close the current InfoWindow.
            infoWindow.close();
            // Create a new InfoWindow.
            infoWindow = new google.maps.InfoWindow({ position: mapsMouseEvent.latLng });
            infoWindow.setContent(mapsMouseEvent.latLng.toString());
            infoWindow.open(map);
            const lat = mapsMouseEvent.latLng.lat();
            const lng = mapsMouseEvent.latLng.lng();

            obs_marker = new google.maps.Marker({
              position: mapsMouseEvent.latLng,
              map: map,
            });
            obs_marker_arr.push(obs_marker);
            arr.push({ lng: parseFloat(lng), lat: parseFloat(lat) });
          });
        });

        //Create obstacle
        document.getElementById("button1").addEventListener("click", function () {
          path_arr.push(arr);
          for (var i = 0; i < obs_marker_arr.length; i++) {
            obs_marker_arr[i].setMap(null);
          }

          const pol = arr.map((p) => [p.lat, p.lng]);
          pol.push(pol[0]);
          const shapefileFeature = turf.polygon([pol]);
          console.log(shapefileFeature);

          for (var i = 0; i < shapefile_geojson.length; i++) {
            if (shapefile_geojson[i].fileName == POLY_NAME) {
              shapefile_geojson[1].features.push(shapefileFeature);
            }
          }

          console.log(shapefile_geojson);

          obs_marker_arr = [];
          shapefile_polygon.setMap(null);
          shapefile_polygon = new google.maps.Polygon({
            paths: path_arr,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
          });

          shapefile_polygon.setMap(map);
          arr = [];
        });

        //Delete Node
        document.getElementById("button2").addEventListener("click", function () {
          arr.pop();
        });

        //Input data button

        document.getElementById("button5").addEventListener("click", function () {
          altitude = Number.parseInt(document.getElementById("altitude").value);
          fov = Number.parseFloat(document.getElementById("fov").value);
          un_kn_obstacle = document.getElementById("select_input").selectedIndex != 1; //false = unknown
          side = (2 * altitude * Math.tan(fov / 57.2958 / 2)) / Math.sqrt(2);

          entry1 = {
            side: side,
          };
          side = side / 1000;

          console.log(side);
          if (no_drones == 1) {
            value_no_drones = document.getElementById("drone").value;
            entry1.value_no_drones = drone.value;
          }

          if (no_drones < value_no_drones) {
            document.getElementById("heading").innerHTML = "DRONE " + (no_drones + 1);
          }

          if (no_drones <= value_no_drones) {
            range.push(Number.parseInt(document.getElementById("range").value));
            speed.push(Number.parseInt(document.getElementById("speed").value));

            entry1.range = range.value;
            entry1.speed = speed.value;

            sessionStorage.setItem("entry1", JSON.stringify(entry1));
            fetch(`${window.origin}/input/hello`, {
              method: "POST",
              credentials: "include",
              body: JSON.stringify(entry1),
              cache: "no-cache",
              headers: new Headers({
                "content-type": "application/json",
              }),
            })
              .then(function (response) {
                if (response.status !== 200) {
                  console.log(`Looks like there was a problem. Status code: ${response.status}`);
                  return;
                }
                response.json().then(function (data) {
                  console.log(data);
                });
              })
              .catch(function (error) {
                console.log("Fetch error: " + error);
              });
            document.getElementById("range").value = null;
            document.getElementById("speed").value = null;
          }

          no_drones += 1;

          if (no_drones == value_no_drones) {
            document.getElementById("button5").innerHTML = "<b>PROCEED</b>";
          } else if (no_drones > value_no_drones) {
            document.getElementById("button5").disabled = true;
            for (var i = 1; i < value_no_drones; i++) {
              document.getElementById("select_input1").innerHTML += '<option value="drone' + (i + 1) + '"> Drone ' + (i + 1) + "</option>";
            }
          }
        });

        //Obstacle -> Fuel
        document.getElementById("next1").addEventListener("click", function () {
          document.getElementById("toggle_button").innerHTML =
            '<h3><b>FUEL STATIONS</b></h3><button class = "control_button" id = "button6"><b> ADD FUEL ST. </b>  </button><button class = "control_button" id = "button7"><b> DELETE FUEL ST. </b>  </button><button class = "control_button" id = "next2"><b> NEXT </b>  </button>';

          //Add fuel stn
          document.getElementById("button6").addEventListener("click", function () {
            if (!flag_fuel) {
              flag_fuel = true;
              flag_strt = false;
              shapefile_polygon.addListener("click", function (mapsMouseEvent) {
                if (flag_fuel) {
                  // Close the current InfoWindow.
                  infoWindow.close();
                  // Create a new InfoWindow.
                  infoWindow = new google.maps.InfoWindow({ position: mapsMouseEvent.latLng });
                  infoWindow.setContent(mapsMouseEvent.latLng.toString());
                  infoWindow.open(map);
                  const lat = mapsMouseEvent.latLng.lat();
                  const lng = mapsMouseEvent.latLng.lng();

                  var point = turf.point([lat, lng]);
                  console.log(point);

                  fuel_marker = new google.maps.Marker({
                    position: mapsMouseEvent.latLng,
                    map: map,
                  });

                  //console.log(fuel_marker);
                  fuel_marker_arr.push(fuel_marker);
                  for (var i = 0; i < shapefile_geojson.length; i++) {
                    if (shapefile_geojson[i].fileName == POINT_NAME) {
                      shapefile_geojson[i].features.push(point);
                    }
                  }
                  console.log(shapefile_geojson);
                }
              });
            }
          });

          //Delete fuel stn
          document.getElementById("button7").addEventListener("click", function () {
            var len = fuel_marker_arr.length;
            fuel_marker_arr[len - 1].setMap(null);
            fuel_marker_arr.pop();

            for (var i = 0; i < shapefile_geojson.length; i++) {
              if (shapefile_geojson[i].fileName == POINT_NAME) {
                shapefile_geojson[i].features.pop();
              }
            }
            console.log(shapefile_geojson);
          });

          //Fuel -> Start
          document.getElementById("next2").addEventListener("click", function () {
            document.getElementById("toggle_button").innerHTML =
              '<h3><b>START POINTS</b></h3><button class = "control_button" id = "button8"><b> ADD START PT. </b>  </button><button class = "control_button" id = "button9"><b> DELETE START PT. </b>  </button><button class = "control_button" id = "button3"><b> SUBMIT </b>  </button>';

            //Submit and Start to Animation
            document.getElementById("button3").addEventListener("click", function () {
              var entry = shapefile_geojson;
              console.log(entry);

              fetch(`${window.origin}/shapefile/create-entry`, {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(entry),
                cache: "no-cache",
                headers: new Headers({
                  "content-type": "application/json",
                }),
              })
                .then(function (response) {
                  if (response.status !== 200) {
                    console.log(`Looks like there was a problem. Status code: ${response.status}`);
                    return;
                  }

                  response.json().then(function (data) {
                    console.log(data);
                    pathCoords = data.lnglatPath;
                    var len = pathCoords.length;

                    var total_len = 0;
                    for (var i = 0; i < len; i++) {
                      total_len += pathCoords[i].length;
                      drone_len[i] = pathCoords[i].length;
                      drone_prog_count.push(0);
                      current_P.push(0);
                      timeouts_P.push([]);
                      for (var j = 0; j < drone_len[i]; j++) {
                        timeouts_P[i].push(null);
                      }
                    }

                    for (var i = 0; i < len; i++) {
                      var new_route1 = new google.maps.Polyline({
                        path: pathCoords[i],
                        geodesic: true,
                        strokeColor: "#FF0000",
                        strokeOpacity: 1.0,
                        strokeWeight: 2,
                        editable: false,
                        map: map,
                      });
                    }
                    var max = 0;
                    //var path_len = 0;
                    var temp = 0;
                    for (var i = 0; i < len; i++) {
                      temp = (pathCoords[i].length * side) / speed[i];
                      if (temp > max) {
                        max = temp;
                        //path_len = pathCoords[i].length;
                      }
                    }

                    console.log(max);
                    max = max * 60 * 2;

                    document.getElementById("toggle_button").innerHTML =
                      '<h3><b>ANIMATION</b></h3><button class = "control_button" id = "button4"><b> PLAY </b>  </button><button class = "control_button" id = "button10"><b> PAUSE </b>  </button><button class = "control_button" id = "button11"><b> ADD DRONE </b>  </button><button class = "control_button" id = "button12"><b> DROP DRONE </b>  </button>';

                    //Play Animation
                    document.getElementById("button4").addEventListener("click", function () {
                      var i, route1, marker1, marker2;

                      var vis_arr = [];

                      for (var i = 0; i < len; i++) {
                        route1 = new google.maps.Polyline({
                          path: [],
                          strokeColor: "#008000",
                          strokeOpacity: 0.5,
                          strokeWeight: 14,
                          editable: false,
                          map: map,
                        });
                        //console.log(route1);
                        route.push(route1);

                        marker1 = new google.maps.Marker({ map: map, icon: "http://maps.google.com/mapfiles/ms/micons/blue.png" });
                        console.log(marker);
                        ani_marker.push(marker1);
                      }

                      flag_pause = false;
                      for (let p = 0; p < route.length; p++) {
                        var count = 0;
                        //console.log(j);
                        for (i = current_P[p]; i < pathCoords[p].length; i++) {
                          timeouts_P[p][i] = setTimeout(
                            function (coords) {
                              if (((range[p] - drone_prog_count[p] * side) / range[p]) * 100 > 0 && !flag_pause) {
                                var latlng = new google.maps.LatLng(coords.lat, coords.lng);
                                route[p].getPath().push(latlng);
                                vis_arr.push((coords.lat, coords.lng));
                                moveMarker(map, ani_marker[p], latlng);
                                count = vis_arr.length;
                                value = (count / total_len) * 100;
                                drone_val[p] = (drone_arr[p] / drone_len[p]) * 100;
                                document.getElementById("file").value = value;
                                drone_prog_count[p]++;
                                current_P[p] = i + 1;
                              }

                              if (p == document.getElementById("select_input1").selectedIndex && !flag_pause) {
                                document.getElementById("file1").value = (drone_prog_count[p] / pathCoords[p].length) * 100;
                                document.getElementById("file2").value = ((range[p] - drone_prog_count[p] * side) / range[p]) * 100;
                              }
                            },
                            (3600000 * side * i) / (speed[p] * max * 2),
                            pathCoords[p][i],
                            p,
                            i
                          );
                        }
                      }
                    });

                    //Pause Animation
                    document.getElementById("button10").addEventListener("click", function () {
                      flag_pause = true;
                      console.log(timeouts_P);
                      for (var i = 0; i < 4; i++) {
                        console.log(current_P[i]);
                        for (var j = current_P[i]; j < pathCoords[i].length; j++) {
                          console.log(timeouts_P[i][j]);
                          console.log(clearTimeout(timeouts_P[i][j]));
                          timeouts_P[i][j] = null;
                        }
                      }
                    });

                    //Add Drone
                    document.getElementById("button11").addEventListener("click", function () {});

                    //Drop Drone
                    document.getElementById("button12").addEventListener("click", function () {});
                  });
                })

                .catch(function (error) {
                  console.log("Fetch error: " + error);
                });
            });

            //Add start pnt
            document.getElementById("button8").addEventListener("click", function () {
              if (!flag_strt) {
                flag_fuel = false;
                flag_strt = true;
                shapefile_polygon.addListener("click", function (mapsMouseEvent) {
                  if (flag_strt) {
                    // Close the current InfoWindow.
                    infoWindow.close();
                    // Create a new InfoWindow.
                    infoWindow = new google.maps.InfoWindow({ position: mapsMouseEvent.latLng });
                    infoWindow.setContent(mapsMouseEvent.latLng.toString());
                    infoWindow.open(map);
                    const lat = mapsMouseEvent.latLng.lat();
                    const lng = mapsMouseEvent.latLng.lng();
                    var point = turf.point([lat, lng]);

                    drone_marker = new google.maps.Marker({
                      position: mapsMouseEvent.latLng,
                      map: map,
                    });

                    drone_marker_arr.push(drone_marker);
                    for (var i = 0; i < shapefile_geojson.length; i++) {
                      if (shapefile_geojson[i].fileName == POINT_NAME) {
                        shapefile_geojson[i].features.push(point);
                      }
                    }
                  }
                });
              }
            });

            //Delete start pnt
            document.getElementById("button9").addEventListener("click", function () {
              var len = drone_marker_arr.length;
              drone_marker_arr[len - 1].setMap(null);
              drone_marker_arr.pop();

              for (var i = 0; i < shapefile_geojson.length; i++) {
                if (shapefile_geojson[i].fileName == POINT_NAME) {
                  shapefile_geojson[i].features.pop();
                }
              }
            });
          });
        });

        function moveMarker(map, marker, latlng) {
          marker.setPosition(latlng);
        }
      }

      function displayDroneData() {
        p = document.getElementById("select_input1").selectedIndex;
        console.log(p);
        document.getElementById("file1").value = (drone_prog_count[p] / pathCoords[p].length) * 100;
        document.getElementById("file2").value = ((range[p] - drone_prog_count[p] * side) / range[p]) * 100;
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkLQlSCLpYWPwDRI2Sjbnpk4DVkRpneSU&callback=initMap"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  </body>
</html>
